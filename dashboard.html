<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… | DZ-TRAFFIC</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
</head>
<body class="bg-gray-50">
    <nav class="bg-white p-4 shadow-sm flex justify-between items-center">
        <h2 class="text-xl font-bold text-blue-600 italic">DZ-TRAFFIC</h2>
        <div class="bg-yellow-100 text-yellow-800 px-4 py-1 rounded-full font-bold">
            Ø±ØµÙŠØ¯Ùƒ: <span id="userPoints">0</span> ğŸª™
        </div>
    </nav>

    <div class="max-w-md mx-auto p-6">
        <h3 class="font-bold mb-4 text-gray-700">Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ù…ØªÙˆÙØ±Ø©:</h3>
        <div id="adsList" class="space-y-3">
            </div>
    </div>

    <script>
        const SUPABASE_URL = "https://nbioqaxgjzpyrbcwdkds.supabase.co";
        const SUPABASE_KEY = "Ø¶Ù€Ø¹_Ù…Ù€ÙÙ€ØªÙ€Ø§Ø­_ANON_Ø§Ù„Ù€Ø®_Ø§Øµ_Ø¨Ù€Ùƒ_Ù‡Ù€Ù†Ù€Ø§";
        const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        async function init() {
            const { data: { user } } = await _supabase.auth.getUser();
            if (!user) window.location.href = "index.html";

            // Ø¬Ù„Ø¨ Ø±ØµÙŠØ¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
            const { data: profile } = await _supabase.from('profiles').select('points').eq('id', user.id).single();
            document.getElementById('userPoints').innerText = profile?.points || 0;

            // Ø¬Ù„Ø¨ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø°ÙŠ Ø£Ø¹Ø¯Ø¯ØªÙ‡
            const { data: ads } = await _supabase.from('ads').select('*');
            const list = document.getElementById('adsList');
            
            ads.forEach(ad => {
                const item = document.createElement('div');
                item.className = "bg-white p-4 rounded-2xl shadow-sm flex justify-between items-center border border-gray-100";
                item.innerHTML = `
                    <div>
                        <p class="font-bold text-gray-800">${ad.title}</p>
                        <p class="text-xs text-gray-400">${ad.required_time} Ø«Ø§Ù†ÙŠØ©</p>
                    </div>
                    <button onclick="startTask('${ad.url}', ${ad.id}, ${ad.reward_points}, ${ad.required_time})" 
                            id="btn-${ad.id}" 
                            class="bg-blue-600 text-white px-5 py-2 rounded-xl font-bold shadow-md hover:bg-blue-700 transition">
                        +${ad.reward_points}
                    </button>
                `;
                list.appendChild(item);
            });
        }

        function startTask(url, id, reward, time) {
            window.open(url, '_blank');
            let timeLeft = time;
            const btn = document.getElementById(`btn-${id}`);
            btn.disabled = true;

            const timer = setInterval(async () => {
                btn.innerText = `${timeLeft}Ø«`;
                if (timeLeft-- <= 0) {
                    clearInterval(timer);
                    btn.innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...";
                    const { data: { user } } = await _supabase.auth.getUser();
                    
                    // ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¯Ø§Ù„Ø© Ù„Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ù†Ù‚Ø§Ø·
                    await _supabase.rpc('increment_points', { user_id: user.id, row_points: reward });
                    
                    alert(`Ù…Ø¨Ø±ÙˆÙƒ! Ø±Ø¨Ø­Øª ${reward} Ù†Ù‚Ø·Ø©`);
                    location.reload();
                }
            }, 1000);
        }

        init();
    </script>
</body>
</html>
